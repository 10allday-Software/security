{
  "AWSTemplateFormatVersion":"2010-09-09",
  "Description":"Infosec Security Audit Role",
  "Metadata":{
    "Source":"https://github.com/mozilla/security/tree/master/operations/aws-security-auditor"
  },
  "Resources":{
    "InfosecSecurityAuditRole":{
      "Type":"AWS::IAM::Role",
      "Properties":{
        "AssumeRolePolicyDocument":{
          "Version":"2012-10-17",
          "Statement":[
            {
              "Sid":"",
              "Effect":"Allow",
              "Principal":{
                "AWS":"arn:aws:iam::371522382791:root"
              },
              "Action":"sts:AssumeRole"
            }
          ]
        },
        "Policies":[
          {
            "PolicyName":"SecurityAudit",
            "PolicyDocument":{
              "Version":"2012-10-17",
              "Statement":[
                {
                  "Action":[
                    "autoscaling:Describe*",
                    "cloudformation:DescribeStack*",
                    "cloudformation:GetTemplate",
                    "cloudformation:ListStack*",
                    "cloudfront:Get*",
                    "cloudfront:List*",
                    "cloudtrail:DescribeTrails",
                    "cloudtrail:GetTrailStatus",
                    "cloudwatch:Describe*",
                    "directconnect:Describe*",
                    "dynamodb:ListTables",
                    "ec2:Describe*",
                    "elasticbeanstalk:Describe*",
                    "elasticache:Describe*",
                    "elasticloadbalancing:Describe*",
                    "elasticmapreduce:Describe*",
                    "elasticmapreduce:List*",
                    "glacier:ListVaults",
                    "iam:Get*",
                    "iam:List*",
                    "rds:Describe*",
                    "rds:DownloadDBLogFilePortion",
                    "rds:ListTagsForResource",
                    "redshift:Describe*",
                    "route53:GetHostedZone",
                    "route53:ListHostedZones",
                    "route53:ListResourceRecordSets",
                    "s3:GetBucket*",
                    "s3:GetLifecycleConfiguration",
                    "s3:GetObjectAcl",
                    "s3:GetObjectVersionAcl",
                    "s3:List*",
                    "sdb:DomainMetadata",
                    "sdb:ListDomains",
                    "ses:Get*",
                    "ses:List*",
                    "sns:GetTopicAttributes",
                    "sns:ListTopics",
                    "sqs:GetQueueAttributes",
                    "sqs:ListQueues",
                    "storagegateway:List*",
                    "storagegateway:Describe*"
                  ],
                  "Effect":"Allow",
                  "Resource":"*"
                }
              ]
            }
          }
        ]
      }
    },
    "PublishToSNSInfo":{
      "Type":"Custom::PublishToSNSInfo",
      "Properties":{
        "ServiceToken":{
          "Fn::GetAtt":[
            "PublishToSNS",
            "Arn"
          ]
        },
        "TopicArn":"arn:aws:sns:us-west-2:371522382791:AccountUpdates",
        "Message":{
          "Fn::Join":[
            "",
            [
              "{\"Security Audit Role ARN\": \"",
              {
                "Fn::GetAtt":[
                  "InfosecSecurityAuditRole",
                  "Arn"
                ]
              },
              "\"}"
            ]
          ]
        }
      }
    },
    "PublishToSNS":{
      "Type":"AWS::Lambda::Function",
      "Properties":{
        "Handler":"publish_to_sns.publish_to_sns",
        "Role":{
          "Fn::GetAtt":[
            "LambdaExecutionRole",
            "Arn"
          ]
        },
        "Code":{
          "S3Bucket": {
            "Fn::Join" : [ "-", [ "infosec-lambda", {"Ref":"AWS::Region"} ] ]
          },
          "S3Key":"publish_to_sns.zip"
        },
        "Runtime":"python2.7",
        "Timeout":"30"
      }
    },
    "LambdaExecutionRole":{
      "Type":"AWS::IAM::Role",
      "Properties":{
        "AssumeRolePolicyDocument":{
          "Version":"2012-10-17",
          "Statement":[
            {
              "Effect":"Allow",
              "Principal":{
                "Service":[
                  "lambda.amazonaws.com"
                ]
              },
              "Action":[
                "sts:AssumeRole"
              ]
            }
          ]
        },
        "Path":"/",
        "Policies":[
          {
            "PolicyName":"root",
            "PolicyDocument":{
              "Version":"2012-10-17",
              "Statement":[
                {
                  "Effect":"Allow",
                  "Action":[
                    "sns:Publish"
                  ],
                  "Resource":"*"
                },
                {
                  "Effect":"Allow",
                  "Action":[
                    "logs:CreateLogGroup",
                    "logs:CreateLogStream",
                    "logs:PutLogEvents"
                  ],
                  "Resource":"arn:aws:logs:*:*:*"
                },
                {
                  "Effect":"Allow",
                  "Action":[
                    "logs:DeleteLogGroup"
                  ],
                  "Resource":{
                    "Fn::Join":[
                      "",
                      [
                        "arn:aws:logs:",
                        {
                          "Ref":"AWS::Region"
                        },
                        ":",
                        {
                          "Ref":"AWS::AccountId"
                        },
                        ":log-group:/aws/lambda/*"
                      ]
                    ]
                  }
                }
              ]
            }
          }
        ]
      }
    }
  },
  "Outputs":{
    "InfosecSecurityAuditRoleARN":{
      "Value":{
        "Fn::GetAtt":[
          "InfosecSecurityAuditRole",
          "Arn"
        ]
      },
      "Description":"The ARN of the new Infosec Security Audit Role"
    }
  }
}