{
  "AWSTemplateFormatVersion":"2010-09-09",
  "Description":"Infosec Security Audit Role",
  "Metadata":{
    "Source":"https://github.com/mozilla/security/tree/master/operations/aws-security-auditor",
    "LambdaFunctionSource":"https://github.com/mozilla/security/tree/master/operations/lambda_functions/publish_to_sns"
  },
  "Mappings" : {
    "Variables": {
      "PublishToSNS": {
        "Arn": "arn:aws:sns:us-west-2:371522382791:cloudformation-stack-emissions"
      }
    }
  },
  "Resources": {
    "InfosecSecurityAuditRole": {
      "Type": "AWS::IAM::Role",
      "Properties": {
        "AssumeRolePolicyDocument": {
          "Version": "2012-10-17",
          "Statement": [
            {
              "Sid": "",
              "Effect": "Allow",
              "Principal": {
                "AWS": "arn:aws:iam::371522382791:root"
              },
              "Action": "sts:AssumeRole"
            }
          ]
        },
        "Policies": [
          {
            "PolicyName": "SecurityAudit",
            "PolicyDocument": {
              "Version": "2012-10-17",
              "Statement": [
                {
                  "Action": [
                    "acm-pca:List*",
                    "acm:Describe*",
                    "acm:List*",
                    "autoscaling:Describe*",
                    "aws-portal:View*",
                    "awsbillingconsole:View*",
                    "cloudformation:Describe*",
                    "cloudformation:Get*",
                    "cloudformation:List*",
                    "cloudfront:Get*",
                    "cloudfront:List*",
                    "cloudtrail:Describe*",
                    "cloudtrail:Get*",
                    "cloudtrail:List*",
                    "cloudwatch:Describe*",
                    "cloudwatch:Get*",
                    "cloudwatch:List*",
                    "config:Describe*",
                    "config:Get*",
                    "config:List*",
                    "directconnect:Describe*",
                    "dynamodb:Describe*",
                    "dynamodb:List*",
                    "ec2:Describe*",
                    "ecs:Describe*",
                    "ecs:List*",
                    "elasticache:Describe*",
                    "elasticbeanstalk:Describe*",
                    "elasticloadbalancing:Describe*",
                    "elasticmapreduce:Describe*",
                    "elasticmapreduce:List*",
                    "es:Describe*",
                    "es:Get*",
                    "es:List*",
                    "glacier:Describe*",
                    "glacier:GetVaultAccessPolicy",
                    "glacier:List*",
                    "guardduty:Get*",
                    "guardduty:List*",
                    "iam:Get*",
                    "iam:List*",
                    "iam:Simulate*",
                    "inspector:Describe*",
                    "inspector:Get*",
                    "inspector:List*",
                    "kms:Describe*",
                    "kms:GetKey*",
                    "kms:List*",
                    "lambda:GetFunctionConfiguration",
                    "lambda:GetLayerVersionPolicy",
                    "lambda:GetPolicy",
                    "lambda:List*",
                    "rds:Describe*",
                    "rds:DownloadDBLogFilePortion",
                    "rds:ListTagsForResource",
                    "redshift:Describe*",
                    "route53:GetHostedZone",
                    "route53:ListHostedZones",
                    "route53:ListResourceRecordSets",
                    "route53domains:GetDomainDetail",
                    "route53domains:ListDomains",
                    "s3:GetAccelerateConfiguration",
                    "s3:GetAnalyticsConfiguration",
                    "s3:GetBucket*",
                    "s3:GetEncryptionConfiguration",
                    "s3:GetInventoryConfiguration",
                    "s3:GetLifecycleConfiguration",
                    "s3:GetLifecycleConfiguration",
                    "s3:GetMetricsConfiguration",
                    "s3:GetObjectAcl",
                    "s3:GetObjectVersionAcl",
                    "s3:GetReplicationConfiguration",
                    "s3:List*",
                    "sdb:DomainMetadata",
                    "sdb:ListDomains",
                    "ses:Get*",
                    "ses:List*",
                    "sns:GetTopicAttributes",
                    "sns:ListSubscriptionsByTopic",
                    "sns:ListTopics",
                    "sqs:Get*",
                    "sqs:List*",
                    "ssm:DescribeAutomationExecutions",
                    "ssm:DescribeInstance*",
                    "ssm:DescribePatch*",
                    "ssm:ListAssociation*",
                    "storagegateway:Describe*",
                    "storagegateway:List*",
                    "support:DescribeTrustedAdvisor*"
                  ],
                  "Effect": "Allow",
                  "Resource": "*"
                }
              ]
            }
          }
        ]
      }
    },
    "PublishIAMRoleArnToSNS": {
      "Type": "Custom::PublishIAMRoleArnToSNS",
      "Version": "1.0",
      "Properties": {
        "ServiceToken": {
          "Fn::FindInMap": [
            "Variables",
            "PublishToSNS",
            "Arn"
          ]
        },
        "category": "AWS Security Auditing Service",
        "SecurityAuditIAMRoleArn": {
          "Fn::GetAtt": [
            "InfosecSecurityAuditRole",
            "Arn"
          ]
        },
        "SecurityAuditIAMRoleName": {
          "Ref": "InfosecSecurityAuditRole"
        }
      }
    }
  },
  "Outputs":{
    "InfosecSecurityAuditRoleARN":{
      "Value":{
        "Fn::GetAtt":[
          "InfosecSecurityAuditRole",
          "Arn"
        ]
      },
      "Description":"The ARN of the new Infosec Security Audit Role"
    }
  }
}
