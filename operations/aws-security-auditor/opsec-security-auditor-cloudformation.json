{
  "AWSTemplateFormatVersion":"2010-09-09",
  "Description":"OpSec Security Auditor",
  "Parameters":{
    "SSHKeyName":{
      "Description":"SSH Key Name",
      "Default":"gene-keys",
      "Type":"String"
    }
  },
  "Mappings":{
    "RegionMap":{
      "us-west-2":{
        "CentOS7x8664withUpdatesHVM":"ami-c7d092f7"
      },
      "us-east-1":{
        "CentOS7x8664withUpdatesHVM":"ami-96a818fe"
      }
    }
  },
  "Resources":{
    "OpSecSecurityAuditorSecurityGroup":{
      "Type":"AWS::EC2::SecurityGroup",
      "Properties":{
        "GroupDescription":"OpSec Security Auditor Server Security Group",
        "SecurityGroupIngress":[
          {
            "FromPort":"443",
            "IpProtocol":"tcp",
            "CidrIp":"0.0.0.0/0",
            "ToPort":"443"
          },
          {
            "FromPort":"22",
            "IpProtocol":"tcp",
            "CidrIp":"0.0.0.0/0",
            "ToPort":"22"
          }
        ],
        "Tags":[
          {
            "Key":"App",
            "Value":"security_auditor"
          },
          {
            "Key":"Type",
            "Value":"app_server"
          },
          {
            "Key":"Stack",
            "Value":{
              "Ref":"AWS::StackName"
            }
          },
          {
            "Key":"Name",
            "Value":"security_auditor"
          }
        ]
      }
    },
    "OpSecSecurityAuditorInstance":{
      "Type":"AWS::EC2::Instance",
      "Properties":{
        "IamInstanceProfile":"OpSecTrustedAuditorInstanceProfile",
        "ImageId":{
          "Fn::FindInMap":[
            "RegionMap",
            {
              "Ref":"AWS::Region"
            },
            "CentOS7x8664withUpdatesHVM"
          ]
        },
        "InstanceType":"t2.micro",
        "KeyName":{
          "Ref":"SSHKeyName"
        },
        "SecurityGroups":[
          {
            "Ref":"OpSecSecurityAuditorSecurityGroup"
          }
        ],
        "Tags":[
          {
            "Key":"App",
            "Value":"security_auditor"
          },
          {
            "Key":"Type",
            "Value":"app_server"
          },
          {
            "Key":"Stack",
            "Value":{
              "Ref":"AWS::StackName"
            }
          },
          {
            "Key":"Name",
            "Value":"security_auditor"
          }
        ]
      }
    }
  }
}