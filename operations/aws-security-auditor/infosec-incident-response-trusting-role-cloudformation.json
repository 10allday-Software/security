{
  "AWSTemplateFormatVersion":"2010-09-09",
  "Description":"Mozilla Enterprise Information Security (EIS) Incident Response Role",
  "Metadata":{
    "Source":"https://github.com/mozilla/security/blob/master/operations/aws-security-auditor/eis-incident-response-role-break-glass.yml",
    "Note1":"Still pending is the potential addition of a CloudWatch Event Rule in this template which detects use of the EISIncidentResponseRole and emits an event to the BreakGlassTopic SNS topic This template can only be deployed in us-west-2, us-east-1, us-west-1 and eu-west-1.\n"
  },
  "Parameters":{
    "EmailAddress":{
      "Type":"String",
      "Default":"",
      "Description":"An optional email address to subscribe to notifications of use of the Incident Response role"
    }
  },
  "Conditions":{
    "EmailAddressIsPresent":{
      "Fn::Not":[
        {
          "Fn::Equals":[
            {
              "Ref":"EmailAddress"
            },
            ""
          ]
        }
      ]
    },
    "RunningInAllowedRegion":{
      "Fn::Equals":[
        {
          "Fn::FindInMap":[
            "TheRegionYouAreDeployingIn",
            {
              "Ref":"AWS::Region"
            },
            "IsNotSupportedPleaseUseADifferentRegion"
          ]
        },
        true
      ]
    }
  },
  "Mappings":{
    "Variables":{
      "SNSTopicForPublishingStackOutput":{
        "Account":371522382791,
        "Topic":"cloudformation-stack-emissions"
      },
      "TrustedEISAccount":{
        "AccountId":415589142697
      },
      "AllowedSNSSubscriber":{
        "AccountId":371522382791
      }
    },
    "TheRegionYouAreDeployingIn":{
      "us-west-2":{
        "WhatIsThisMapping":"This constrains the regions in which you can deploy this template to only the regions listed in this mapping. This, for example, prevents deploying in ap-south-1",
        "IsNotSupportedPleaseUseADifferentRegion":true
      },
      "us-east-1":{
        "WhatIsThisMapping":"",
        "IsNotSupportedPleaseUseADifferentRegion":true
      },
      "us-west-1":{
        "WhatIsThisMapping":"",
        "IsNotSupportedPleaseUseADifferentRegion":true
      },
      "eu-west-1":{
        "WhatIsThisMapping":"",
        "IsNotSupportedPleaseUseADifferentRegion":true
      }
    }
  },
  "Resources":{
    "EISIncidentResponseRole":{
      "Type":"AWS::IAM::Role",
      "Properties":{
        "AssumeRolePolicyDocument":{
          "Version":"2012-10-17",
          "Statement":[
            {
              "Sid":"AllowEISTrustedToAssume",
              "Effect":"Allow",
              "Principal":{
                "AWS":{
                  "Fn::Join":[
                    "",
                    [
                      "arn:aws:iam::",
                      {
                        "Fn::FindInMap":[
                          "Variables",
                          "TrustedEISAccount",
                          "AccountId"
                        ]
                      },
                      ":root"
                    ]
                  ]
                }
              },
              "Action":"sts:AssumeRole"
            }
          ]
        },
        "ManagedPolicyArns":[
          "arn:aws:iam::aws:policy/AdministratorAccess"
        ]
      }
    },
    "BreakGlassTopic":{
      "Type":"AWS::SNS::Topic",
      "Properties":{
        "DisplayName":"Notifications of use of the EIS Incident Response IAM Role",
        "TopicName":"EISIncidentResponseBreakGlass"
      }
    },
    "BreakGlassTopicPolicy":{
      "Type":"AWS::SNS::TopicPolicy",
      "Properties":{
        "Topics":[
          {
            "Ref":"BreakGlassTopic"
          }
        ],
        "PolicyDocument":{
          "Version":"2012-10-17",
          "Id":"BreakGlassPolicy",
          "Statement":[
            {
              "Action":"sns:Publish",
              "Principal":{
                "AWS":[
                  {
                    "Fn::Join":[
                      "",
                      [
                        "arn:aws:iam::",
                        {
                          "Fn::FindInMap":[
                            "Variables",
                            "TrustedEISAccount",
                            "AccountId"
                          ]
                        },
                        ":root"
                      ]
                    ]
                  }
                ]
              },
              "Resource":{
                "Ref":"BreakGlassTopic"
              },
              "Effect":"Allow",
              "Sid":"BreakGlassPublisher"
            },
            {
              "Action":"sns:Publish",
              "Principal":"*",
              "Resource":{
                "Ref":"BreakGlassTopic"
              },
              "Effect":"Allow",
              "Sid":"BreakGlassServicePublisher",
              "Condition":{
                "StringEquals":{
                  "AWS:SourceAccount":{
                    "Fn::FindInMap":[
                      "Variables",
                      "TrustedEISAccount",
                      "AccountId"
                    ]
                  }
                }
              }
            },
            {
              "Action":[
                "sns:GetTopicAttributes",
                "sns:ListSubscriptionsByTopic",
                "sns:Subscribe"
              ],
              "Principal":{
                "AWS":[
                  {
                    "Fn::Join":[
                      "",
                      [
                        "arn:aws:iam::",
                        {
                          "Fn::FindInMap":[
                            "Variables",
                            "AllowedSNSSubscriber",
                            "AccountId"
                          ]
                        },
                        ":root"
                      ]
                    ]
                  },
                  {
                    "Fn::Join":[
                      "",
                      [
                        "arn:aws:iam::",
                        {
                          "Fn::FindInMap":[
                            "Variables",
                            "TrustedEISAccount",
                            "AccountId"
                          ]
                        },
                        ":root"
                      ]
                    ]
                  }
                ]
              },
              "Resource":{
                "Ref":"BreakGlassTopic"
              },
              "Effect":"Allow",
              "Sid":"BreakGlassSubscriber"
            }
          ]
        }
      }
    },
    "OptionalEmailSubscription":{
      "Type":"AWS::SNS::Subscription",
      "Condition":"EmailAddressIsPresent",
      "Properties":{
        "Endpoint":{
          "Ref":"EmailAddress"
        },
        "Protocol":"email",
        "TopicArn":{
          "Ref":"BreakGlassTopic"
        }
      }
    },
    "EmitStackOutput":{
      "Type":"Custom::EmitStackOutput",
      "Version":"1.0",
      "Properties":{
        "ServiceToken":{
          "Fn::Join":[
            ":",
            [
              "arn:aws:sns",
              {
                "Ref":"AWS::Region"
              },
              {
                "Fn::FindInMap":[
                  "Variables",
                  "SNSTopicForPublishingStackOutput",
                  "Account"
                ]
              },
              {
                "Fn::FindInMap":[
                  "Variables",
                  "SNSTopicForPublishingStackOutput",
                  "Topic"
                ]
              }
            ]
          ]
        },
        "category":"AWS Incident Response Service",
        "EISIncidentResponseAccountIAMRoleArn":{
          "Fn::GetAtt":[
            "EISIncidentResponseRole",
            "Arn"
          ]
        },
        "EISIncidentResponseAccountIAMRoleName":{
          "Ref":"EISIncidentResponseRole"
        },
        "BreakGlassSNSTopicArn":{
          "Ref":"BreakGlassTopic"
        },
        "BreakGlassSNSTopicName":{
          "Fn::GetAtt":[
            "BreakGlassTopic",
            "TopicName"
          ]
        }
      }
    }
  }
}
