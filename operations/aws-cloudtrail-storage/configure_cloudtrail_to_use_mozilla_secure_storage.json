{
  "AWSTemplateFormatVersion":"2010-09-09",
  "Description":"Deploy CloudTrail configurations in all regions using lambda",
  "Metadata":{
    "Source":"https://github.com/mozilla/security/tree/master/operations/aws-cloudtrail-storage"
  },
  "Resources":{
    "CloudTrailInfo":{
      "Type":"Custom::CloudTrailInfo",
      "Properties":{
        "ServiceToken":{
          "Fn::GetAtt":[
            "SubStackManager",
            "Arn"
          ]
        },
        "BucketName": "mozilla-cloudtrail-logs"
        
      }
    },
    "SubStackManager":{
      "Type":"AWS::Lambda::Function",
      "Properties":{
        "Handler":"configure_cloudtrail_to_use_mozilla_secure_storage.configure_cloudtrail_to_use_mozilla_secure_storage",
        "Role":{
          "Fn::GetAtt":[
            "LambdaExecutionRole",
            "Arn"
          ]
        },
        "Code":{
          "S3Bucket": {
            "Fn::Join" : [ "-", [ "infosec-lambda", {"Ref":"AWS::Region"} ] ]
          },
          "S3Key":"configure_cloudtrail_to_use_mozilla_secure_storage.zip"
        },
        "Runtime":"python2.7",
        "Timeout":"30"
      }
    },
    "LambdaExecutionRole":{
      "Type":"AWS::IAM::Role",
      "Properties":{
        "AssumeRolePolicyDocument":{
          "Version":"2012-10-17",
          "Statement":[
            {
              "Effect":"Allow",
              "Principal":{
                "Service":[
                  "lambda.amazonaws.com"
                ]
              },
              "Action":[
                "sts:AssumeRole"
              ]
            }
          ]
        },
        "Path":"/",
        "Policies":[
          {
            "PolicyName":"root",
            "PolicyDocument":{
              "Version":"2012-10-17",
              "Statement":[
                {
                  "Effect":"Allow",
                  "Action":[
                    "iam:GetUser",
                    "ec2:DescribeRegions",
                    "cloudtrail:DescribeTrails",
                    "cloudtrail:DeleteTrail",
                    "cloudformation:CreateStack",
                    "cloudformation:DescribeStacks",
                    "sns:Publish",
                    "cloudtrail:CreateTrail",
                    "cloudtrail:StartLogging"
                  ],
                  "Resource":"*"
                },
                {
                  "Effect":"Allow",
                  "Action":[
                    "logs:CreateLogGroup",
                    "logs:CreateLogStream",
                    "logs:PutLogEvents"
                  ],
                  "Resource":"arn:aws:logs:*:*:*"
                },
                {
                  "Effect":"Allow",
                  "Action":[
                    "logs:DeleteLogGroup"
                  ],
                  "Resource":{
                    "Fn::Join":[
                      "",
                      [
                        "arn:aws:logs:",
                        {
                          "Ref":"AWS::Region"
                        },
                        ":",
                        {
                          "Ref":"AWS::AccountId"
                        },
                        ":log-group:/aws/lambda/*"
                      ]
                    ]
                  }
                },
                {
                  "Effect":"Allow",
                  "Action":[
                    "cloudformation:DeleteStack"
                  ],
                  "Resource":{
                    "Fn::Join":[
                      "",
                      [
                        "arn:aws:cloudformation:*:",
                        {
                          "Ref":"AWS::AccountId"
                        },
                        ":stack/MozillaSecuredCloudTrail/*"
                      ]
                    ]
                  }
                }
              ]
            }
          }
        ]
      }
    }
  }
}