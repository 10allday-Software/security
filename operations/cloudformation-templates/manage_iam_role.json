{
  "AWSTemplateFormatVersion":"2010-09-09",
  "Description":"Create IAM role",
  "Metadata":{
    "Source":"https://github.com/mozilla/security/tree/master/operations/cloudformation-templates"
  },
  "Parameters":{
    "RoleName":{
      "Description":"IAM Role Name",
      "Type":"String",
      "MinLength":1,
      "MaxLength":64,
      "AllowedPattern":"^[a-zA-Z][-a-zA-Z0-9]*$"
    },
    "TrustedEntities":{
      "Description":"Trusted AWS ARNs",
      "Type":"CommaDelimitedList"
    }
  },
  "Resources":{
    "RoleInfo":{
      "Type":"Custom::RoleInfo",
      "Properties":{
        "ServiceToken":{
          "Fn::GetAtt":[
            "RoleManager",
            "Arn"
          ]
        },
        "RoleName":{
          "Ref":"RoleName"
        },
        "TrustedEntities":{
          "Ref":"TrustedEntities"
        }
      }
    },
    "RoleManager":{
      "Type":"AWS::Lambda::Function",
      "Properties":{
        "Handler":"manage_iam_role.manage_iam_role",
        "Role":{
          "Fn::GetAtt":[
            "LambdaExecutionRole",
            "Arn"
          ]
        },
        "Code":{
          "S3Bucket": {
            "Fn::Join" : [ "-", [ "infosec-lambda", {"Ref":"AWS::Region"} ] ]
          },
          "S3Key":"manage_iam_role.zip"
        },
        "Runtime":"python2.7",
        "Timeout":"30"
      }
    },
    "LambdaExecutionRole":{
      "Type":"AWS::IAM::Role",
      "Properties":{
        "AssumeRolePolicyDocument":{
          "Version":"2012-10-17",
          "Statement":[
            {
              "Effect":"Allow",
              "Principal":{
                "Service":[
                  "lambda.amazonaws.com"
                ]
              },
              "Action":[
                "sts:AssumeRole"
              ]
            }
          ]
        },
        "Path":"/",
        "Policies":[
          {
            "PolicyName":"root",
            "PolicyDocument":{
              "Version":"2012-10-17",
              "Statement":[
                {
                  "Effect":"Allow",
                  "Action":[
                    "iam:CreateRole"
                  ],
                  "Resource":"*"
                },
                {
                  "Effect":"Allow",
                  "Action":[
                    "iam:DeleteRole"
                  ],
                  "Resource":{
                    "Fn::Join":[
                      "",
                      [
                        "arn:aws:iam::",
                        {
                          "Ref":"AWS::AccountId"
                        },
                        ":role/",
                        {
                          "Ref":"RoleName"
                        }
                      ]
                    ]
                  }
                },
                {
                  "Effect":"Allow",
                  "Action":[
                    "logs:CreateLogGroup",
                    "logs:CreateLogStream",
                    "logs:PutLogEvents"
                  ],
                  "Resource":"arn:aws:logs:*:*:*"
                },
                {
                  "Effect":"Allow",
                  "Action":[
                    "logs:DeleteLogGroup"
                  ],
                  "Resource":{
                    "Fn::Join":[
                      "",
                      [
                        "arn:aws:logs:",
                        {
                          "Ref":"AWS::Region"
                        },
                        ":",
                        {
                          "Ref":"AWS::AccountId"
                        },
                        ":log-group:/aws/lambda/*"
                      ]
                    ]
                  }
                }
              ]
            }
          }
        ]
      }
    }
  },
  "Outputs":{
    "RoleARN":{
      "Description":"The ARN of the new role",
      "Value":{
        "Fn::GetAtt":[
          "RoleInfo",
          "Arn"
        ]
      }
    }
  }
}